USE master 
GO

ALTER DATABASE PHONGKHAM_DB SET SINGLE_USER WITH ROLLBACK IMMEDIATE
GO

-- 1/ Tạo DB
IF DB_ID('PHONGKHAM_DB') IS NOT NULL
	DROP DATABASE  PHONGKHAM_DB
GO

Create Database PHONGKHAM_DB
GO
Use PHONGKHAM_DB
GO
	
-- 2/ Tạo các table + Khoá chính
-- Bảng Nhân Viên
CREATE TABLE NHANVIEN
(
	ID CHAR(8) PRIMARY KEY,
	HOTEN NVARCHAR(50),
	NGAYSINH DATE,
	DIACHI NVARCHAR(200),
	SDT CHAR(10),
	GIOITINH NVARCHAR(4) CHECK (GIOITINH IN (N'Nam', N'Nữ')),
	MATKHAU CHAR(8)
)
GO
-- Bảng Nha Sĩ	
CREATE TABLE NHASI
(
	ID char(8) PRIMARY KEY,
	HOTEN nvarchar(50),
	NGAYSINH date,
	DIACHI nvarchar(200),
	SDT char(10),
	GIOITINH NVARCHAR(4) CHECK (GIOITINH IN (N'Nam', N'Nữ')),
	MATKHAU char(8)
)
GO

CREATE TABLE LICHLAMVIEC
(
	NHASI char(8),
	NGAY date,
	THOIGIAN TIME,
	TRANGTHAI binary,
	PRIMARY KEY (NHASI,NGAY,THOIGIAN),
	FOREIGN KEY (NHASI) REFERENCES NHASI(ID)
)

-- Bảng QTV
CREATE TABLE QTV
(
	ID char(8) PRIMARY KEY,
	HOTEN nvarchar(50),
	NGAYSINH date,
	DIACHI nvarchar(200),
	SDT char(10),
	GIOITINH NVARCHAR(4) CHECK (GIOITINH IN (N'Nam', N'Nữ')),
	MATKHAU char(8)
)
GO

-- Bảng Bệnh Nhân
-- Bảng Bệnh Án của Bệnh Nhân
CREATE TABLE BENHAN
(
	ID char(8) PRIMARY KEY,
	HOTEN nvarchar(50),
	NGAYSINH date,
	DIACHI nvarchar(200),
	SDT char(10),
	GIOITINH NVARCHAR(4) CHECK (GIOITINH IN (N'Nam', N'Nữ')),
	THONGTINTONGQUAN nvarchar(200),
	TINHTRANGDIUNG nvarchar(200),
)
GO
CREATE TABLE THUOCCHONGCHIDINH
(
	BENHNHAN char(8),
	IDTHUOC char(8),
	PRIMARY KEY(BENHNHAN,IDTHUOC),
)

CREATE TABLE KHDIEUTRI
(
	ID CHAR(8),
	BENHNHAN CHAR(8),
	TRANGTHAI INT,
	PRIMARY KEY(BENHNHAN,ID),
	FOREIGN KEY (BENHNHAN) REFERENCES BENHAN(ID)
)
GO
CREATE TABLE DIEUTRI
(
	MADIEUTRI int,
	BENHNHAN char(8),
	KEHOACH char(8),
	NHASI char(8),
	NGAY DATE,
	PRIMARY KEY(BENHNHAN,KEHOACH,MADIEUTRI),
	MOTA NVARCHAR(255),
	GIA FLOAT,
	TRANGTHAI int,
	FOREIGN KEY (NHASI) REFERENCES NHASI(ID),
	FOREIGN KEY (BENHNHAN,KEHOACH) REFERENCES KHDIEUTRI(BENHNHAN,ID)
)

CREATE TABLE RANG(
	MARANG INT, 
	TENRANG NVARCHAR(40)

	PRIMARY KEY(MARANG)
)

CREATE TABLE MATRANG(
	MAMATRANG CHAR(1), 
	TENMATRANG NVARCHAR(40)

	PRIMARY KEY (MAMATRANG)
)

CREATE TABLE CHONRANG(
	BENHNHAN CHAR(8),
	MARANG INT, 
	MAMATRANG CHAR(1), 

	PRIMARY KEY(BENHNHAN, MARANG, MAMATRANG),
	FOREIGN KEY (BENHNHAN) REFERENCES BENHAN(ID), 
	FOREIGN KEY (MARANG) REFERENCES RANG(MARANG), 
	FOREIGN KEY (MAMATRANG) REFERENCES MATRANG(MAMATRANG), 
)

GO
CREATE TABLE THANHTOAN
(
	MADIEUTRI INT,
	BENHNHAN CHAR(8),
	KEHOACH CHAR(8),
	PRIMARY KEY(BENHNHAN,KEHOACH,MADIEUTRI),
	LATIENMAT BINARY,
	TIENNHAN FLOAT,
	TIENTHOI FLOAT,
	NGAYTT DATE,
	FOREIGN KEY (BENHNHAN,KEHOACH,MADIEUTRI) REFERENCES DIEUTRI(BENHNHAN,KEHOACH,MADIEUTRI) ,
)
GO
CREATE TABLE CUOCHEN
(
	ID INT,
	BENHNHAN CHAR(8),
	NHASI CHAR(8),
	PRIMARY KEY(ID, BENHNHAN),
	NGAYHEN DATE,
	GIOHEN TIME,
	GHICHU NVARCHAR(200),
	TRANGTHAI BINARY,
	LATAIKHAM BINARY,
	FOREIGN KEY (BENHNHAN) REFERENCES BENHAN(ID),
	FOREIGN KEY (NHASI) REFERENCES NHASI(ID)
)
GO

-----------------
CREATE TABLE THUOC (
    ID_THUOC VARCHAR(8) PRIMARY KEY,
    TENTHUOC NVARCHAR(255),
    DONGIA INT,
    DONVI NVARCHAR(50),
	SOLUONG INT,
	HANSUDUNG DATE,
	GHICHU NVARCHAR(255)
)
GO

CREATE TABLE DONTHUOC (
	ID_DON VARCHAR(8),
	ID_BENHAN CHAR(8),
	NGAYLAPDON DATE,

	PRIMARY KEY (ID_DON, ID_BENHAN),
	FOREIGN KEY (ID_BENHAN) REFERENCES dbo.BENHAN(ID),
)
GO

CREATE TABLE CHITIETDON (
	ID_DON VARCHAR(8),
	ID_BENHAN CHAR(8),
	ID_THUOC VARCHAR(8),
	SOLUONG INT,

	PRIMARY KEY (ID_DON, ID_BENHAN, ID_THUOC),
	FOREIGN KEY (ID_DON, ID_BENHAN) REFERENCES dbo.DONTHUOC(ID_DON, ID_BENHAN),
	FOREIGN KEY (ID_THUOC) REFERENCES dbo.THUOC(ID_THUOC)
)
GO

----------------------------------------------------------------------------------------------------------------
-- 3/ Thêm Data

-- Chèn dữ liệu cho bảng NHASI
INSERT INTO NHASI (ID, HOTEN, NGAYSINH, DIACHI, SDT, GIOITINH, MATKHAU)
VALUES
    ('NS000001', N'Nha Si 1', '1990-01-01', N'123 Đường ABC, Quận XYZ', '1234567890', N'Nam', 'pass1234'),
    ('NS000002', N'Nha Si 2', '1985-05-05', N'456 Đường XYZ, Quận ABC', '0987654321', N'Nữ', 'pass4567');

	-- Chèn dữ liệu cho bảng NHASI
INSERT INTO NHANVIEN(ID, HOTEN, NGAYSINH, DIACHI, SDT, GIOITINH, MATKHAU)
VALUES
    ('NS000001', N'Nhan vien 1', '1990-01-01', N'123 Đường ABC, Quận XYZ', '1234567890', N'Nam', 'pass1234'),
    ('NS000002', N'Nhan vien 2', '1985-05-05', N'456 Đường XYZ, Quận ABC', '0987654321', N'Nữ', 'pass4567');

-- Chèn dữ liệu cho bảng LICHLAMVIEC
INSERT INTO LICHLAMVIEC (NHASI, NGAY, THOIGIAN, TRANGTHAI)
VALUES
    ('NS000001', '2023-01-15', '08:00:00.0000000', 1),
    ('NS000002', '2023-01-15', '09:00:00.0000000', 0),
	('NS000001', '2023-01-15', '09:00:00.0000000', 1);
-- Chèn dữ liệu cho bảng QTV
INSERT INTO QTV (ID, HOTEN, NGAYSINH, DIACHI, SDT, GIOITINH, MATKHAU)
VALUES
    ('QTV00001', N'Quan Tri Vien 1', '1988-07-20', N'789 Đường XYZ, Quận ABC', '0123456789', N'Nam', 'qtvpass');

-- Chèn dữ liệu cho bảng BENHAN
INSERT INTO BENHAN (ID, HOTEN, NGAYSINH, DIACHI, SDT, GIOITINH,  THONGTINTONGQUAN)
VALUES
    ('BN000001', N'Nguyen Van A', '1992-03-10', N'321 Đường XYZ, Quận ABC', '1112223333', N'Nam','Tong quan benh ly 1'),
    ('BN000002', N'Tran Thi B', '1980-12-05', N'555 Đường ABC, Quận XYZ', '4445556666', N'Nữ', 'Tong quan benh ly 2');
-- Chèn dữ liệu cho bảng KHDIEUTRI
INSERT INTO KHDIEUTRI(ID, BENHNHAN, TRANGTHAI) 
VALUES
	('KH000001','BN000001', 1),
	('KH000002', 'BN000001', 0),
	('KH000001', 'BN000002', 0);
-- Chèn dữ liệu cho bảng DIEUTRI


INSERT INTO DIEUTRI (MADIEUTRI, BENHNHAN, KEHOACH, NHASI, NGAY,  MOTA, GIA, TRANGTHAI)
VALUES
(1, 'BN000001', 'KH000001', 'NS000001', '2023-01-01', N'Treatment for BN000001', 1500000, 1),
(2, 'BN000001', 'KH000002', 'NS000002', '2023-02-01',  N'Treatment for BN000002', 500000, 1),
(1, 'BN000002', 'KH000001', 'NS000001', '2023-02-01',  N'Treatment for BN000002', 500000, 1);

INSERT INTO THANHTOAN (MADIEUTRI, BENHNHAN, KEHOACH, LATIENMAT, TIENNHAN, TIENTHOI, NGAYTT)
VALUES
(1, 'BN000001', 'KH000001', 0x01, 100.0, 50.0, '2023-01-15'),
(2, 'BN000001', 'KH000002', 0x00, 200.0, 0.0, '2023-02-20'),
(1, 'BN000002', 'KH000001', 0x00, 200.0, 0.0, '2023-02-20');

-- Chèn dữ liệu cho bảng TAIKHAM
INSERT INTO CUOCHEN(ID, BENHNHAN, NHASI,NGAYHEN, GIOHEN, GHICHU, LATAIKHAM, TRANGTHAI)
VALUES
    (1, 'BN000001', 'NS000001', '2023-01-15' ,'08:30:00', N'ghi chu', 1, 1),
	(2, 'BN000001', 'NS000001', '2023-02-18' ,'14:00:00', N'ghi chu', 0, 0),
    (1, 'BN000002', 'NS000001', '2023-02-18' ,'14:00:00', N'ghi chu', 0, 0);

--Chèn dữ liệu cho bảng THUOC
INSERT INTO THUOC (ID_THUOC, TENTHUOC, DONGIA, DONVI, SOLUONG, HANSUDUNG, GHICHU)
VALUES 
('TH000001', N'Paracetamol', 5000, N'Viên', 100, '2024-12-31', N'Thuốc hạ sốt'),
('TH000002', N'Amoxicillin', 8000, N'Viên', 50, '2025-06-30', N'Kháng sinh'),
('TH000003', N'Ibuprofen', 7000, N'Viên', 80, '2024-09-30', N'Thuốc giảm đau'),
('TH000004', N'Aspirin', 6000, N'Viên', 120, '2024-11-30', N'Thuốc chống viêm'),
('TH000005', N'Cetirizine', 9000, N'Viên', 30, '2025-04-30', N'Thuốc chống dị ứng');

-- Inserting data into DONTHUOC table
INSERT INTO DONTHUOC (ID_DON, ID_BENHAN, NGAYLAPDON)
VALUES 
('DT000001', 'BN000001', '2023-08-15'),
('DT000002', 'BN000001', '2023-09-20'),
('DT000003', 'BN000001', '2023-10-05'),
('DT000001', 'BN000002', '2023-11-12'),
('DT000002', 'BN000002', '2023-12-03');

-- Inserting data into CHITIETDON table
INSERT INTO CHITIETDON (ID_DON, ID_BENHAN, ID_THUOC, SOLUONG)
VALUES 
('DT000001', 'BN000001', 'TH000001', 20),
('DT000001', 'BN000001', 'TH000002', 30),
('DT000001', 'BN000001', 'TH000003', 10);

-- QUAN LY HOSOBENHNHAN: BENHAN
-- Tìm các liên kết tái khám của bệnh nhân: 'BN000001'

-- CHO PHÉP INSERT CUỘC HẸN:
-- BÁC SĨ -> NGÀY HẸN -> Completed
/* 
VD: 
BENHNHAN: ID = 'BN000001'

IF ISTAIKHAM = 1:
	NHASI = 'Default';
	NGAYHEN = MIN('Default'/LICHLAMVIEC)
ELSE: 
	NGAYHEN = '01/01/2023'
	NHASI = OneOfList(Lichlamviec/ngayhen/trangthai = 0)
GIOHEN = [sang/chieu],


INSERT INTO CUOCHEN(ID, BENHNHAN, NHASI,NGAYHEN, GIOHEN, GHICHU, LATAIKHAM, TRANGTHAI)
VALUES (
COMPLETED!
*/

CREATE PROCEDURE XemLichLamViec
    @NHASI CHAR(8)
AS
BEGIN
    SELECT NHASI, NGAY, THOIGIAN, TRANGTHAI
    FROM LICHLAMVIEC
    WHERE NHASI = @NHASI
    ORDER BY NGAY, THOIGIAN;
END;




