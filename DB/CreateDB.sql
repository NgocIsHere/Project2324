-- 1/ Tạo DB


IF DB_ID('PHONGKHAM_DB2') IS NOT NULL
	DROP DATABASE  PHONGKHAM_DB2
GO

Create Database PHONGKHAM_DB2
GO
Use PHONGKHAM_DB2
GO
	
-- 2/ Tạo các table + Khoá chính
-- Bảng Nhân Viên
CREATE TABLE NHANVIEN
(
	ID char(8) PRIMARY KEY,
	HOTEN nvarchar(50),
	NGAYSINH date,
	DIACHI nvarchar(200),
	SDT char(10),
	GIOITINH INT,
	MATKHAU char(8)
)
GO
-- Bảng Nha Sĩ	
CREATE TABLE NHASI
(
	ID char(8) PRIMARY KEY,
	HOTEN nvarchar(50),
	NGAYSINH date,
	DIACHI nvarchar(200),
	SDT char(10),
	GIOITINH INT,
	MATKHAU char(8)
)
GO

CREATE TABLE LICHLAMVIEC
(
	NHASI char(8),
	NGAY date,
	THOIGIAN TIME,
	TRANGTHAI INT,
	PRIMARY KEY (NHASI,NGAY,THOIGIAN),
	FOREIGN KEY (NHASI) REFERENCES NHASI(ID)
)

-- Bảng QTV
CREATE TABLE QTV
(
	ID char(8) PRIMARY KEY,
	HOTEN nvarchar(50),
	NGAYSINH date,
	DIACHI nvarchar(200),
	SDT char(10),
	GIOITINH INT,
	MATKHAU char(8)
)
GO

-- Bảng Bệnh Nhân
-- Bảng Bệnh Án của Bệnh Nhân
/*: Gồm thông tin cơ bản của bệnh nhân như
tên, tuổi, giới tính, tổng tiền điều trị, tổng tiền điều trị đã thanh toán,
thông tin tổng quan về sức khỏe răng miệng của bệnh nhân, ghi chú về
tình trạng dị ứng và chống chỉ định thuốc của bệnh nhân. */
CREATE TABLE BENHAN
(
	ID char(8) PRIMARY KEY,
	HOTEN nvarchar(50),
	NGAYSINH date,
	DIACHI nvarchar(200),
	SDT char(10),
	GIOITINH INT,
	THONGTINTONGQUAN nvarchar(200),
	TINHTRANGDIUNG nvarchar(200),
)
GO
CREATE TABLE THUOCCHONGCHIDINH
(
	BENHNHAN char(8),
	IDTHUOC char(8),
	PRIMARY KEY(BENHNHAN,IDTHUOC),
)
/*
KEHOACHDIEUTRI(id:'BN000001,KH00001'): 
KEHOACHDIEUTRI(id:'BN000001,KH00002'):

KEHOACHDIEUTRI(id:'BN000001,KH00001'): 
MADIEUTRI NHASI   NGAY BLA  BLA
   01       X     Y   Z    K
   02       X     Y   Z    K
BENHNHAN/KEHOACHDIEUTRI(id:'BN000001,KH00002'):
MADIEUTRI NHASI   NGAY BLA  BLA
   01       X     Y   Z    K
   02       X     Y   Z    K
*/
CREATE TABLE KHDIEUTRI
(
	ID CHAR(8),
	BENHNHAN CHAR(8),
	TRANGTHAI INT,
	PRIMARY KEY(BENHNHAN,ID),
	FOREIGN KEY (BENHNHAN) REFERENCES BENHAN(ID)
)
GO
CREATE TABLE DIEUTRI
(
	MADIEUTRI int,
	BENHNHAN char(8),
	KEHOACH char(8),
	NHASI char(8),
	NGAY DATE,
	PRIMARY KEY(BENHNHAN,KEHOACH,MADIEUTRI),
	MOTA NVARCHAR(255),
	GIA FLOAT,
	TRANGTHAI int,
	FOREIGN KEY (NHASI) REFERENCES NHASI(ID),
	FOREIGN KEY (BENHNHAN,KEHOACH) REFERENCES KHDIEUTRI(BENHNHAN,ID)
)

CREATE TABLE RANG(
	MARANG INT, 
	TENRANG NVARCHAR(40)

	PRIMARY KEY(MARANG)
)

CREATE TABLE MATRANG(
	MAMATRANG CHAR(1), 
	TENMATRANG NVARCHAR(40)

	PRIMARY KEY (MAMATRANG)
)

CREATE TABLE CHONRANG(
	BENHNHAN CHAR(8),
	MARANG INT, 
	MAMATRANG CHAR(1), 

	PRIMARY KEY(BENHNHAN, MARANG, MAMATRANG),
	FOREIGN KEY (BENHNHAN) REFERENCES BENHAN(ID), 
	FOREIGN KEY (MARANG) REFERENCES RANG(MARANG), 
	FOREIGN KEY (MAMATRANG) REFERENCES MATRANG(MAMATRANG), 
)

GO
CREATE TABLE THANHTOAN
(
	MADIEUTRI int,
	BENHNHAN char(8),
	KEHOACH char(8),
	PRIMARY KEY(BENHNHAN,KEHOACH,MADIEUTRI),
	LATIENMAT INT,
	TIENNHAN float,
	TIENTHOI float,
	NGAYTT DATE,
	FOREIGN KEY (BENHNHAN,KEHOACH,MADIEUTRI) REFERENCES DIEUTRI(BENHNHAN,KEHOACH,MADIEUTRI) ,
)
GO
CREATE TABLE CUOCHEN
(
	ID INT,
	BENHNHAN char(8),
	NHASI char(8),
	PRIMARY KEY(ID, BENHNHAN),
	NGAYHEN date,
	GIOHEN TIME,
	GHICHU NVARCHAR(200),
	TRANGTHAI INT,
	LATAIKHAM INT,
	FOREIGN KEY (BENHNHAN) REFERENCES BENHAN(ID),
	FOREIGN KEY (NHASI) REFERENCES NHASI(ID)
)
GO

-----------------
CREATE TABLE THUOC (
    Thuoc_ID INT PRIMARY KEY,
    TenThuoc VARCHAR(255),
    DonGia DECIMAL(10, 2),
    DonVi VARCHAR(50)
)
GO
CREATE TABLE LOTHUOC (
    Lo_ID INT PRIMARY KEY,
    Thuoc_ID INT,
    NgayNhap DATE,
    SoLuong INT,
    TongGiaTri DECIMAL(10,2),
    NgayHetHan DATE,
    FOREIGN KEY (Thuoc_ID) REFERENCES THUOC(Thuoc_ID)
)
GO
CREATE TABLE NHACUNGCAPTHUOC (
    NCC_ID INT PRIMARY KEY,
    Ten VARCHAR(255),
    DiaChi NVARCHAR(200),
    SDT CHAR(10)
)
GO
-- 3/ Thêm Data

-- Chèn dữ liệu cho bảng NHASI
INSERT INTO NHASI (ID, HOTEN, NGAYSINH, DIACHI, SDT, GIOITINH, MATKHAU)
VALUES
    ('NS000001', 'Nha Si 1', '1990-01-01', '123 Đường ABC, Quận XYZ', '1234567890', 1, 'pass1234'),
    ('NS000002', 'Nha Si 2', '1985-05-05', '456 Đường XYZ, Quận ABC', '0987654321', 0, 'pass4567');

-- Chèn dữ liệu cho bảng LICHLAMVIEC
INSERT INTO LICHLAMVIEC (NHASI, NGAY, THOIGIAN, TRANGTHAI)
VALUES
    ('NS000001', '2023-01-15', '08:00:00.0000000', 1),
    ('NS000002', '2023-01-15', '09:00:00.0000000', 0),
	('NS000001', '2023-01-15', '09:00:00.0000000', 1);
-- Chèn dữ liệu cho bảng QTV
INSERT INTO QTV (ID, HOTEN, NGAYSINH, DIACHI, SDT, GIOITINH, MATKHAU)
VALUES
    ('QTV00001', 'Quan Tri Vien 1', '1988-07-20', '789 Đường XYZ, Quận ABC', '0123456789', 1, 'qtvpass');

-- Chèn dữ liệu cho bảng BENHAN
INSERT INTO BENHAN (ID, HOTEN, NGAYSINH, DIACHI, SDT, GIOITINH,  THONGTINTONGQUAN)
VALUES
    ('BN000001', 'Nguyen Van A', '1992-03-10', '321 Đường XYZ, Quận ABC', '1112223333', 1,'Tong quan benh ly 1'),
    ('BN000002', 'Tran Thi B', '1980-12-05', '555 Đường ABC, Quận XYZ', '4445556666', 0, 'Tong quan benh ly 2');
-- Chèn dữ liệu cho bảng KHDIEUTRI
INSERT INTO KHDIEUTRI(ID, BENHNHAN, TRANGTHAI) 
VALUES
	('KH000001','BN000001', 1),
	('KH000002', 'BN000001', 0),
	('KH000001', 'BN000002', 0);
-- Chèn dữ liệu cho bảng DIEUTRI


INSERT INTO DIEUTRI (MADIEUTRI, BENHNHAN, KEHOACH, NHASI, NGAY,  MOTA, GIA, TRANGTHAI)
VALUES
(1, 'BN000001', 'KH000001', 'NS000001', '2023-01-01', 'Treatment for BN000001', 1500000, 1),
(2, 'BN000001', 'KH000002', 'NS000002', '2023-02-01',  'Treatment for BN000002', 500000, 1),
(1, 'BN000002', 'KH000001', 'NS000001', '2023-02-01',  'Treatment for BN000002', 500000, 1);

INSERT INTO THANHTOAN (MADIEUTRI, BENHNHAN, KEHOACH, LATIENMAT, TIENNHAN, TIENTHOI, NGAYTT)
VALUES
(1, 'BN000001', 'KH000001', 0x01, 100.0, 50.0, '2023-01-15'),
(2, 'BN000001', 'KH000002', 0x00, 200.0, 0.0, '2023-02-20'),
(1, 'BN000002', 'KH000001', 0x00, 200.0, 0.0, '2023-02-20');

-- Chèn dữ liệu cho bảng TAIKHAM
INSERT INTO CUOCHEN(ID, BENHNHAN, NHASI,NGAYHEN, GIOHEN, GHICHU, LATAIKHAM, TRANGTHAI)
VALUES
    (1, 'BN000001', 'NS000001', '2023-01-15' ,'08:30:00','ghi chu', 1, 1),
	(2, 'BN000001', 'NS000001', '2023-02-18' ,'14:00:00','ghi chu', 0, 0),
    (1, 'BN000002', 'NS000001', '2023-02-18' ,'14:00:00','ghi chu', 0, 0);

-- QUAN LY HOSOBENHNHAN: BENHAN
-- Tìm các liên kết tái khám của bệnh nhân: 'BN000001'

-- CHO PHÉP INSERT CUỘC HẸN:
-- BÁC SĨ -> NGÀY HẸN -> Completed
/* 
VD: 
BENHNHAN: ID = 'BN000001'

IF ISTAIKHAM = 1:
	NHASI = 'Default';
	NGAYHEN = MIN('Default'/LICHLAMVIEC)
ELSE: 
	NGAYHEN = '01/01/2023'
	NHASI = OneOfList(Lichlamviec/ngayhen/trangthai = 0)
GIOHEN = [sang/chieu],


INSERT INTO CUOCHEN(ID, BENHNHAN, NHASI,NGAYHEN, GIOHEN, GHICHU, LATAIKHAM, TRANGTHAI)
VALUES (
COMPLETED!
*/

select *
from BENHAN

