
USE PHONGKHAM_DB2
GO

CREATE PROCEDURE ADD_APPOINTMENT
--ALTER PROCEDURE ADD_APPOINTMENT
					@ID INT, 
					@BENHNHAN CHAR(8), 
					@NHASI CHAR(8), 
					@NGAYHEN DATE, 
					@GIOHEN TIME, 
					@GHICHU NVARCHAR(200), 
					@TRANGTHAI BINARY, 
					@LATAIKHAM BINARY, 
					@USER CHAR(8)
AS 
BEGIN
	DECLARE @IS_EMPLOYEE INT;
	DECLARE @IS_ADMIN INT;

	SET @IS_EMPLOYEE = (SELECT COUNT(*) 
						FROM NHANVIEN NV
						WHERE @USER = NV.ID )
	SET @IS_ADMIN = (SELECT COUNT(*) 
						FROM QTV QTV
						WHERE @USER = QTV.ID)

	IF @IS_EMPLOYEE > 0 OR @IS_ADMIN > 0 
		BEGIN
			INSERT INTO CUOCHEN(ID, BENHNHAN, NHASI, NGAYHEN, GIOHEN, GHICHU, TRANGTHAI, LATAIKHAM)
			VALUES (@ID, @BENHNHAN, @NHASI, @NGAYHEN, @GIOHEN, @GHICHU, @TRANGTHAI, @LATAIKHAM);
		END
	ELSE
	    RAISERROR ('An error occurred.', 16, 1);

END
GO	


ALTER PROCEDURE DYNAMIC_INSERT
	@TableName NVARCHAR(128),
    @ColumnName NVARCHAR(128),
    @Value NVARCHAR(128),
    @DataType NVARCHAR(128)
AS
BEGIN
    DECLARE @sql NVARCHAR(MAX);

    SET @sql = N'INSERT INTO ' + QUOTENAME(@TableName) 
        + ' (' + QUOTENAME(@ColumnName) + ') VALUES (CAST(' 
        + QUOTENAME(@Value, '''') + ' AS ' + @DataType + '));';

    EXEC sp_executesql @sql;
END;


EXEC DYNAMIC_INSERT 'CUOCHEN', ''

--CREATE PROCEDURE ALTER_APPOINTMENT
ALTER PROCEDURE ALTER_APPOINTMENT
					@ID INT, 
					@BENHNHAN CHAR(8), 
					@NHASI CHAR(8), 
					@NGAYHEN DATE, 
					@GIOHEN TIME, 
					@GHICHU NVARCHAR(200), 
					@TRANGTHAI BINARY, 
					@LATAIKHAM BINARY, 
					@USER CHAR(8), 
					@RESULT INT OUTPUT
AS 
BEGIN
	DECLARE @IS_EMPLOYEE INT;
	DECLARE @IS_ADMIN INT;

	SET @IS_EMPLOYEE = (SELECT COUNT(*) 
						FROM NHANVIEN NV
						WHERE @USER = NV.ID )
	SET @IS_ADMIN = (SELECT COUNT(*) 
						FROM QTV QTV
						WHERE @USER = QTV.ID)

	IF (@IS_EMPLOYEE > 0 OR @IS_ADMIN > 0) AND EXISTS(SELECT CH.ID FROM CUOCHEN CH WHERE CH.ID = @ID) 
		BEGIN
			UPDATE CUOCHEN
			SET BENHNHAN = @BENHNHAN, 
				NHASI = @NHASI, 
				NGAYHEN = @NGAYHEN, 
				GIOHEN = @GIOHEN, 
				GHICHU = @GHICHU,
				TRANGTHAI = @TRANGTHAI,
				LATAIKHAM = @LATAIKHAM
			WHERE ID = @ID
			SET @RESULT = 1

		END
	ELSE 
		SET @RESULT = 0
END
GO		

ALTER PROCEDURE DELETE_CUOC_HEN
	@ID INT,
	@USER CHAR(8)
AS
BEGIN

	DECLARE @IS_EMPLOYEE INT;
	DECLARE @IS_ADMIN INT;

	SET @IS_EMPLOYEE = (SELECT COUNT(*) 
						FROM NHANVIEN NV
						WHERE @USER = NV.ID )
	SET @IS_ADMIN = (SELECT COUNT(*) 
						FROM QTV QTV
						WHERE @USER = QTV.ID)
	IF @IS_EMPLOYEE > 0 OR @IS_ADMIN > 0 
		DELETE 
		FROM CUOCHEN
		WHERE ID = @ID
	ELSE
		RAISERROR ('An error occurred.', 16, 1);

END;
GO

--ALTER PROCEDURE [dbo].[SELECT_CUOC_HEN]
CREATE PROCEDURE SELECT_CUOC_HEN
	@COLUMNNAME NVARCHAR(40), 
	@SORTORDER NVARCHAR(4)
AS
BEGIN
	DECLARE @SQLCOMMAND NVARCHAR(MAX)
	SET @SQLCOMMAND = N'SELECT * FROM CUOCHEN ORDER BY ' + QUOTENAME(@COLUMNNAME) + ' ' + 
						CASE WHEN @SORTORDER = 'DESC' THEN 'DESC' ELSE 'ASC' END;
	EXEC sp_executesql @SQLCOMMAND
END;

--ALTER PROCEDURE GET_CUOC_HEN_FROM_DATE
CREATE PROCEDURE GET_CUOC_HEN_FROM_DATE
	@STARTDATE DATE, 
	@ENDDATE DATE, 
	@USER CHAR(8)
AS
BEGIN
	DECLARE @IS_ADMIN INT
	SET @IS_ADMIN = (SELECT COUNT(*) 
						FROM QTV QTV
						WHERE @USER = QTV.ID)
	IF @IS_ADMIN > 0
		BEGIN
			SELECT * 
			FROM CUOCHEN
			WHERE CUOCHEN.NGAYHEN BETWEEN @STARTDATE AND @ENDDATE
		END
END;
GO

SELECT * FROM BENHAN 
SELECT * FROM NHANVIEN
SELECT * FROM NHASI
SELECT * FROM QTV
SELECT * FROM CUOCHEN

INSERT INTO NHANVIEN(ID, HOTEN, NGAYSINH, DIACHI, SDT, GIOITINH, MATKHAU)
VALUES ('NV000001', N'BÙI HOÀNG DUY', '2003-10-22', N'HÓC MÔN, HỒ CHÍ MINH', '0123456789', 1, '12345678')

EXEC ADD_APPOINTMENT 10, 'BN000001', 'NS000001', '2023-11-25', '10:30:00', N'BỆNH NHÂN BỊ DỊ ỨNG VỚI PARACITEMOL, CÓ TIỀN LỆ ĐAU TIM', 0,0, 'NV000001'

DECLARE @RESULT INT;
EXEC ALTER_APPOINTMENT 3, 'BN000001', 'NS000001', '2023-11-25', '10:30:00', N'BỆNH NHÂN BỊ DỊ ỨNG VỚI PARACITEMOL, CÓ TIỀN LỆ ĐAU TIM',1,0, 'NV000001' , @RESULT OUTPUT
PRINT @RESULT 

EXEC GET_CUOC_HEN_FROM_DATE '2023-02-18', '2023-11-25', 'QTV00001'
EXEC SELECT_CUOC_HEN 'ID', 'ASC'

EXEC DELETE_CUOC_HEN 5, 'NV000001'

SELECT * FROM CUOCHEN

EXEC ADD_APPOINTMENT 1, 'BN000002', 'NS000002', '23-18-25', '01-18-38', N'UNG THƯ', 0,1, 'NV000001'



EXEC GET_CUOC_HEN_FROM_DATE '2023-11-20', '2023-12-25', 'QTV00001'
EXEC ADD_APPOINTMENT 6, 'BN000001', 'NS000001', '2023-12-30', '16-30-00', N'DUY', 0,1, 'NV000001'
